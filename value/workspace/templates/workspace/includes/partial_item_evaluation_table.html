{% load relative_col_size %}
{% load evaluation_options %}
{% load panel_class %}
{% load evaluation_percent %}

{% csrf_token %}

{% for item in items %}
  <div class="panel {% panel_class evaluations=evaluations item=item factors=factors %} panel-collapsable{% if not forloop.first %} panel-collapsed{% endif %}">
    <div class="panel-heading">
      <span class="badge pull-right">{% evaluation_percent evaluations=evaluations item=item factors=factors %}</span>
      <h3 class="panel-title">{{ item.name }}</h3>
    </div>
    {% regroup factors by measure as factors_grouped_by_measure %}

    {% if factors_grouped_by_measure|length > 1 %}
      <div class="panel-body"{% if not forloop.first %} style="display: none"{% endif %}>
    {% endif %}

    {% for factors_group in factors_grouped_by_measure %}
      <table class="table"{% if not forloop.parentloop.first %}{% if factors_grouped_by_measure|length <= 1 %} style="display: none"{% endif %}{% endif %}>
        <thead>
          <tr>
            <th style="width: 25%">Value Factors</th>
            {% with factors_group.list|first as first_factor %}
              {% for measure in first_factor.measure.get_values %}
                <th class="text-center" style="width: {{ first_factor.measure.get_values|relative_col_size }}">{{ measure.description }}</th>
              {% endfor %}
            {% endwith %}
          </tr>
        </thead>
        <tbody>
          {% for factor in factors_group.list %}
            {% evaluation_options evaluations=evaluations item=item factor=factor %}
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}

    {% if factors_grouped_by_measure|length > 1 %}
      </div>
    {% endif %}
  </div>
{% endfor %}